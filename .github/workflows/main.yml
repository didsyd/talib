name: Build 64-bit TA-Lib Wheel for Latest Python on Windows 10

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_64bit_wheel:
    name: Build 64-bit Wheel
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ['3.11']
    env:
      VS_PLATFORM: x64
    steps:
      # Step 1: Check out the repository
      - uses: actions/checkout@v4

      # Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      # Step 3: Download TA-Lib Source Files
      - name: Download TA-Lib source files
        run: |
          echo "Downloading TA-Lib source files..."
          powershell -Command "Invoke-WebRequest -Uri https://sourceforge.net/projects/ta-lib/files/ta-lib/0.4.0/ta-lib-0.4.0-msvc.zip -OutFile ta-lib-src.zip"
          if (Test-Path ta-lib-src.zip) {
            echo 'TA-Lib source files downloaded successfully.'
          } else {
            Write-Error 'Error: TA-Lib source files failed to download.'
            exit 1
          }

      # Step 4: Extract TA-Lib Source Files
      - name: Extract TA-Lib source files
        run: |
          echo "Extracting TA-Lib source files..."
          powershell -Command "Expand-Archive -Path ta-lib-src.zip -DestinationPath ."
          if (Test-Path ta-lib-0.4.0-msvc) {
            echo 'TA-Lib source files extracted successfully.'
          } else {
            Write-Error 'Error: Failed to extract TA-Lib source files.'
            exit 1
          }

      # Step 5: Move TA-Lib source files to the expected directory structure
      - name: Organize TA-Lib source files
        run: |
          mkdir -p ta-lib/c/src
          move ta-lib-0.4.0-msvc/* ta-lib/c/src
          echo "TA-Lib files moved to the correct location."

      # Step 6: Install build dependencies
      - name: Install Build Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install setuptools wheel numpy Cython
          pip install pytest

      # Step 7: Build the TA-Lib wheel
      - name: Build TA-Lib Wheel
        run: |
          set LIB="ta-lib\\c\\ide\\vs2022\\lib_proj\\x64;$LIB"
          python setup.py bdist_wheel
        working-directory: ta-lib/c/src

      # Step 8: Upload the built wheel as an artifact
      - name: Upload Wheel Artifact
        uses: actions/upload-artifact@v4
        with:
          path: ./dist/*.whl
          name: ta-lib-64bit-wheel
